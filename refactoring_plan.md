# SemiTerm リファクタリング計画

**作成日**: 2025-12-26  
**バージョン**: 2.0  
**対象リポジトリ**: SemiTerm

---

## 📊 エグゼクティブサマリー

本ドキュメントは、SemiTermプロジェクトの包括的なリファクタリング計画を提供します。コードベース全体を分析し、アーキテクチャ、コード品質、パフォーマンス、テスタビリティの観点から改善が必要な領域を特定しました。

### 主要な発見事項
- **Main プロセスの肥大化**: 588行の単一ファイルに全機能が集中
- **複雑なドラッグ&ドロップロジック**: 346行の巨大フックで保守困難
- **型安全性の問題**: IPC通信で型の不整合が存在
- **パフォーマンスの最適化余地**: 不要な再レンダリングとメモ化不足

### 推定工数
- **総工数**: 4-6週間
- **優先度高**: 1-2週間
- **優先度中**: 1-2週間
- **優先度低**: 2週間

---

## 🔍 コードベース分析結果

### プロジェクト概要
- **技術スタック**: Electron + React + TypeScript + xterm.js
- **アーキテクチャ**: Main/Renderer プロセス分離
- **総ファイル数**: 約40ファイル
- **主要コンポーネント**: 
  - Main プロセス: SSH接続管理、データベース操作
  - Renderer プロセス: UI、タブ管理、カスタムフック
- **コード品質**: 全体的に良好だが、改善の余地あり

### ファイル構成
```
SemiTerm/
├── src/
│   ├── main/
│   │   └── index.ts (588行 - 要分割)
│   ├── preload/
│   │   └── index.ts (52行)
│   └── renderer/
│       └── src/
│           ├── App.tsx (336行)
│           ├── Terminal.tsx (108行)
│           ├── ConnectionEditor.tsx (187行)
│           ├── hooks/ (7ファイル)
│           ├── components/ (15ファイル)
│           └── utils/ (3ファイル)
```

---

## 🚨 特定された問題点

### 1. アーキテクチャ上の問題

#### 1.1 Main プロセスの肥大化 🔴
- **問題**: [`index.ts`](SemiTerm/src/main/index.ts)が588行で、ウィンドウ管理、SSH接続、データベース操作、IPC通信が混在
- **影響**: テストが困難、変更時の影響範囲が不明確、責任の分離不足
- **対策**: 機能別にモジュール分割（WindowManager、SshSessionManager、DatabaseStore、IPCハンドラー）

#### 1.2 カスタムフックの責任範囲 🔴
- **問題**: [`useDragAndDrop.ts`](SemiTerm/src/renderer/src/hooks/useDragAndDrop.ts)が346行で、状態管理、イベント処理、ビジネスロジックが混在
- **影響**: 再利用困難、テスト困難、変更時のリスク大
- **対策**: ロジックを小さな関数に分割、状態管理とビジネスロジックを分離

### 2. コードの重複と冗長性

#### 2.1 ドラッグ&ドロップロジックの重複 🟡
- **問題**: [`FolderNode.tsx`](SemiTerm/src/renderer/src/components/connection/FolderNode.tsx)と[`ConnectionItem.tsx`](SemiTerm/src/renderer/src/components/connection/ConnectionItem.tsx)で類似のD&Dロジック
- **対策**: 共通ロジックを[`dragDropUtils.ts`](SemiTerm/src/renderer/src/utils/dragDropUtils.ts)に集約

#### 2.2 正規化ロジックの重複 🟡
- **問題**: Main/Rendererプロセスで接続データの正規化ロジックが重複
- **対策**: 共通の正規化関数を作成し、両プロセスで共有

#### 2.3 コンテキストメニュー状態管理の重複 🟡
- **問題**: 複数のコンポーネントで類似のコンテキストメニュー状態管理
- **対策**: [`useContextMenu.ts`](SemiTerm/src/renderer/src/hooks/useContextMenu.ts)フックに統一

### 3. 型安全性とエラーハンドリング

#### 3.1 型の不整合 🔴
- **問題**: IPC通信でMain/Renderer間の型定義が不一致、`Connection`型と`ConnectionData`型の使い分けが不明確
- **対策**: 共有型定義ファイルを作成、型ガード関数の実装

#### 3.2 エラーハンドリングの不足 🟡
- **問題**: SSH接続エラー、データベースエラーの処理が不統一
- **対策**: 統一的なエラーハンドリング戦略の実装、カスタムエラークラスの作成

#### 3.3 any型の使用 🟡
- **問題**: 一部のイベントハンドラーやユーティリティ関数で`any`型を使用
- **対策**: 適切な型定義への置き換え

### 4. パフォーマンス最適化の機会

#### 4.1 不要な再レンダリング 🟡
- **問題**: [`App.tsx`](SemiTerm/src/renderer/src/App.tsx)で状態変更時に全コンポーネントが再レンダリング
- **対策**: `React.memo`、`useMemo`、`useCallback`の適切な使用

#### 4.2 メモ化の不足 🟡
- **問題**: 計算コストの高い処理（接続ツリーの構築、フィルタリング）がメモ化されていない
- **対策**: `useMemo`による計算結果のキャッシュ

#### 4.3 大量のイベントリスナー 🟡
- **問題**: 各接続アイテムに個別のイベントリスナーが設定
- **対策**: イベントデリゲーションパターンの採用

### 5. テスタビリティとメンテナンス性

#### 5.1 テストの困難さ 🟢
- **問題**: 巨大なコンポーネントとフックのテストが困難
- **対策**: 小さな単位への分割、依存性注入の活用

#### 5.2 マジックナンバー 🟡
- **問題**: ハードコードされた数値（タイムアウト値、サイズ、インデックス）
- **対策**: 定数ファイルへの集約

#### 5.3 ハードコードされた値 🟡
- **問題**: 設定値がコード内に直接記述
- **対策**: 設定ファイルまたは環境変数への移行

---

## 🎯 リファクタリング計画（優先順位順）

### 優先度: 高 🔴

#### 1. Main プロセスの分割
**目的**: メンテナンス性とテスタビリティの向上  
**推定工数**: 2-3日  
**影響範囲**: Main プロセス全体

**実装計画**:
- WindowManager: ウィンドウ管理の分離
- SshSessionManager: SSH接続管理の分離
- DatabaseStore: データベース操作の分離
- IPCハンドラー: IPC通信処理の分離

**新しいファイル構成**:
```
SemiTerm/src/main/
├── index.ts (エントリーポイント、100行以下)
├── window/WindowManager.ts
├── ssh/SshSessionManager.ts
├── ssh/SshConnectionHandler.ts
├── database/ConnectionStore.ts
├── database/FolderStore.ts
├── ipc/DatabaseHandlers.ts
├── ipc/SshHandlers.ts
└── utils/Logger.ts
```

**実装ステップ**:
1. 各機能のインターフェース設計
2. WindowManagerの実装と移行
3. SshSessionManagerの実装と移行
4. DatabaseStoreの実装と移行
5. IPCハンドラーの実装と移行
6. 統合テストと動作確認

#### 2. ドラッグ&ドロップロジックのリファクタリング
**目的**: コードの再利用性と保守性の向上  
**推定工数**: 2-3日  
**影響範囲**: D&D関連コンポーネントとフック

**実装計画**:
- 状態管理ロジックの分離
- イベントハンドラーの共通化
- ビジネスロジックのユーティリティ化

**新しいファイル構成**:
```
SemiTerm/src/renderer/src/
├── hooks/
│   ├── useDragAndDrop.ts (状態管理のみ、100行以下)
│   └── useDragState.ts (ドラッグ状態管理)
└── utils/
    ├── dragDropUtils.ts (共通ロジック)
    └── dragDropHandlers.ts (イベントハンドラー)
```

**実装ステップ**:
1. 共通ロジックの抽出とユーティリティ化
2. 状態管理の分離
3. イベントハンドラーの共通化
4. コンポーネントへの適用
5. 動作確認とテスト

#### 3. 型安全性の向上
**目的**: バグの早期発見と開発効率の向上  
**推定工数**: 1-2日  
**影響範囲**: 全プロセス

**実装計画**:
- 共有型定義ファイルの作成
- IPC通信の型安全化
- 型ガード関数の実装

**新しいファイル構成**:
```
SemiTerm/src/
├── shared/
│   ├── types/
│   │   ├── connection.ts
│   │   ├── ssh.ts
│   │   └── ipc.ts
│   └── guards/
│       └── typeGuards.ts
```

**実装ステップ**:
1. 共有型定義の作成
2. IPC通信インターフェースの定義
3. 型ガード関数の実装
4. 既存コードへの適用
5. 型チェックの確認

---

### 優先度: 中 🟡

#### 4. エラーハンドリングの統一
**目的**: エラー処理の一貫性と信頼性の向上  
**推定工数**: 1-2日  
**影響範囲**: 全プロセス

**実装計画**:
- カスタムエラークラスの作成
- エラーハンドリングミドルウェアの実装
- ユーザーフレンドリーなエラーメッセージ

**実装ステップ**:
1. エラークラス階層の設計
2. エラーハンドリングユーティリティの実装
3. 既存エラー処理の置き換え
4. エラーログの統一
5. ユーザー通知の改善

#### 5. 定数の集約
**目的**: 保守性の向上と変更の容易化  
**推定工数**: 0.5-1日  
**影響範囲**: 全プロセス

**実装計画**:
- 定数ファイルの作成
- マジックナンバーの置き換え
- 設定値の外部化

**新しいファイル構成**:
```
SemiTerm/src/
├── shared/
│   └── constants/
│       ├── ui.ts (UI関連定数)
│       ├── ssh.ts (SSH関連定数)
│       └── app.ts (アプリケーション設定)
```

**実装ステップ**:
1. 定数の洗い出し
2. カテゴリ別の定数ファイル作成
3. 既存コードの置き換え
4. 設定値の環境変数化

#### 6. パフォーマンス最適化
**目的**: アプリケーションの応答性向上  
**推定工数**: 2-3日  
**影響範囲**: Rendererプロセス

**実装計画**:
- React.memoの適用
- useMemo/useCallbackの活用
- イベントデリゲーションの実装
- 仮想スクロールの検討

**実装ステップ**:
1. パフォーマンスボトルネックの特定
2. コンポーネントのメモ化
3. 計算処理のメモ化
4. イベントハンドラーの最適化
5. パフォーマンス測定と検証

---

### 優先度: 低 🟢

#### 7. コンポーネントの細分化
**目的**: 再利用性とテスタビリティの向上  
**推定工数**: 2-3日  
**影響範囲**: Rendererプロセス

**実装計画**:
- 大きなコンポーネントの分割
- プレゼンテーショナルコンポーネントの抽出
- カスタムフックの細分化

**実装ステップ**:
1. コンポーネント責任の分析
2. プレゼンテーショナル/コンテナの分離
3. 共通UIコンポーネントの抽出
4. カスタムフックの分割
5. ストーリーブックの作成（オプション）

---

## 📋 実装チェックリスト

### フェーズ1: 基盤整備（優先度: 高）
- [x] Main プロセスの分割 ✅ 2025-12-27完了
  - [x] WindowManager実装
  - [x] SshSessionManager実装
  - [x] DatabaseStore実装
  - [x] IPCハンドラー実装
- [x] ドラッグ&ドロップリファクタリング ✅ 2025-12-27完了
  - [x] 共通ロジック抽出
  - [x] 状態管理分離
  - [x] コンポーネント適用
- [x] 型安全性の向上 ✅ 2025-12-27完了
  - [x] 共有型定義作成
  - [x] 型ガード実装
  - [x] IPC型安全化

### フェーズ2: 品質向上（優先度: 中）
- [x] エラーハンドリング統一 ✅ 2025-12-27完了
  - [x] カスタムエラークラス
  - [x] エラーハンドリングユーティリティ
  - [x] Main/Rendererプロセスへの適用
- [x] 定数の集約 ✅ 2025-12-28完了
  - [x] 定数ファイル作成
  - [x] マジックナンバー置き換え
- [x] パフォーマンス最適化 ✅ 2025-12-28完了
  - [x] メモ化実装
  - [x] イベント最適化

### フェーズ3: 仕上げ（優先度: 低）
- [x] コンポーネント細分化 ✅ 2026-01-06完了
  - [x] 大きなコンポーネント分割
  - [x] 共通コンポーネント抽出

---

## 🎯 成功指標

### 定量的指標
- Main プロセスのファイル数: 1 → 8+
- 最大ファイル行数: 588行 → 200行以下
- TypeScript型カバレッジ: 向上
- ビルド時間: 維持または改善

### 定性的指標
- コードの可読性向上
- テストの書きやすさ向上
- 新機能追加の容易性向上
- バグ修正の影響範囲の明確化

---

## ⚠️ リスクと対策

### リスク
1. **既存機能の破壊**: リファクタリング中のバグ混入
2. **工数超過**: 想定以上の複雑性
3. **パフォーマンス劣化**: 過度な抽象化

### 対策
1. 段階的な実装とテスト
2. 各フェーズ後の動作確認
3. パフォーマンス測定の実施
4. ロールバック計画の準備

---

## 📝 次のステップ

1. **レビューと承認**: 本計画のレビューと承認取得
2. **環境準備**: テスト環境とブランチの準備
3. **フェーズ1開始**: Main プロセス分割から着手
4. **継続的な評価**: 各フェーズ後の効果測定

---

## 📝 実装履歴

### 2025-12-28: 定数の集約完了
**実装内容**:
- 定数ファイルの作成（`SemiTerm/src/shared/constants/`）
  - `ui.ts`: UI関連定数（ウィンドウサイズ、レイアウト、メニュー、アニメーション、ターミナル設定等）
  - `ssh.ts`: SSH関連定数（デフォルトポート、タイムアウト、認証タイプ、接続状態等）
  - `app.ts`: アプリケーション設定定数（アプリ情報、タブ管理、配列操作、パス操作等）
  - `index.ts`: 定数のエクスポート
- マジックナンバーの置き換え
  - `WindowManager.ts`: ウィンドウサイズ定数の適用
  - `SshSessionManager.ts`: SSH設定定数の適用
  - `Terminal.tsx`: ターミナル設定とテーマ定数の適用
  - `ConnectionEditor.tsx`: SSHデフォルトポートの適用
  - `contextMenuUtils.ts`: スペーシング定数の適用
  - `useContextMenu.ts`: メニューサイズ定数の適用

**成果**:
- TypeScriptコンパイル成功
- ビルド成功（エラーなし）
- マジックナンバーの削減
- 保守性の向上（設定値の一元管理）
- 変更の容易化（定数ファイルのみ編集で全体に反映）

### 2025-12-27: エラーハンドリング統一完了
**実装内容**:
- カスタムエラークラスの作成（`SemiTerm/src/shared/errors/AppError.ts`）
  - `AppError`, `SshError`, `DatabaseError`, `FileSystemError`, `ValidationError`, `ProgrammingError`
  - エラーコード定数の定義
- エラーハンドリングユーティリティの実装
  - Main プロセス用: `SemiTerm/src/shared/errors/errorHandler.ts`
  - Renderer プロセス用: `SemiTerm/src/renderer/src/utils/errorUtils.ts`
- Main プロセスのエラーハンドリング統一
  - SSH接続エラーの詳細な分類とユーザーフレンドリーなメッセージ
  - 全データベースIPCハンドラーへの`withErrorHandling`適用
  - 成功/失敗レスポンスの統一
- Renderer プロセスのエラーハンドリング統一
  - `useSshSession.ts`と`useConnections.ts`の更新
  - エラーレスポンスのアンラップとユーザー通知の改善

**成果**:
- TypeScriptコンパイル成功
- ビルド成功（エラーなし）
- エラー処理の一貫性向上
- ユーザーフレンドリーなエラーメッセージ
- デバッグ性の向上

### 2025-12-27: Mainプロセス分割完了
**成果**:
- Mainプロセスのファイル数: 1 → 11ファイル
- 最大ファイル行数: 748行 → 305行（59%削減）
- index.tsの行数: 748行 → 60行（92%削減）
- TypeScriptコンパイル成功
- ビルド成功（エラーなし）

---

### 2025-12-28: パフォーマンス最適化完了
**実装内容**:
- React.memoによるコンポーネントのメモ化
  - `ConnectionItem`: カスタム比較関数で不要な再レンダリングを防止
  - `FolderNode`: ドラッグ状態とツリー構造の変更のみで再レンダリング
  - `Sidebar`: 接続ツリーと展開状態の変更のみで再レンダリング
  - `StatusBar`: ステータス情報の変更のみで再レンダリング
  - `WelcomeScreen`: propsが変わらない限り再レンダリングしない
  - `ErrorScreen`: エラーメッセージの変更のみで再レンダリング
- useMemoによる計算結果のキャッシュ
  - `connectionTree`: 接続、フォルダ、フォルダ情報の変更時のみ再計算
- useCallbackによるイベントハンドラーの最適化
  - App.tsx内の全イベントハンドラーをメモ化
  - タブドラッグ、コンテキストメニュー、再接続などの処理を最適化
- イベントハンドラーの統合
  - 重複するイベントハンドラーを共通化
  - インラインハンドラーをメモ化された関数に置き換え

**成果**:
- TypeScriptコンパイル成功
- ビルド成功（エラーなし）
- 不要な再レンダリングの削減
- メモリ使用量の最適化
- イベントハンドラーの効率化
- コンポーネントの応答性向上

**最適化の詳細**:
1. **コンポーネントレベルの最適化**
   - 6つの主要コンポーネントをReact.memoでメモ化
   - カスタム比較関数で精密な再レンダリング制御
   - 型安全なドラッグアイテムの比較ロジック

2. **計算処理の最適化**
   - connectionTreeの構築をuseMemoでキャッシュ
   - 依存配列による適切な再計算タイミングの制御

3. **イベントハンドラーの最適化**
   - 15個以上のイベントハンドラーをuseCallbackでメモ化
   - インラインハンドラーの削減
   - 依存配列の最適化

4. **パフォーマンス向上の期待効果**
   - 状態変更時の再レンダリング範囲の最小化
   - 大量の接続アイテムでのスクロール性能向上
   - ドラッグ&ドロップ操作の滑らかさ向上
   - タブ切り替えの応答性向上

**最終更新**: 2026-01-06 16:40 JST

---

### 2026-01-06: コンポーネント細分化完了
**実装内容**:
- TabBarコンポーネントの抽出（`SemiTerm/src/renderer/src/components/layout/TabBar.tsx`）
  - タブバーのUI表示とドラッグ&ドロップロジックを分離
  - React.memoによる最適化
  - 82行の独立したコンポーネント
- TabContentAreaコンポーネントの抽出（`SemiTerm/src/renderer/src/components/layout/TabContentArea.tsx`）
  - タブコンテンツの表示ロジックを分離
  - Welcome/Error/Terminalの条件分岐を集約
  - React.memoによる最適化
  - 82行の独立したコンポーネント
- ConnectionEditorのフォーム細分化
  - ConnectionInfoFieldsコンポーネント（`SemiTerm/src/renderer/src/components/forms/ConnectionInfoFields.tsx`）
    - 基本接続情報フィールドを抽出
    - 82行の再利用可能なコンポーネント
  - AuthenticationFieldsコンポーネント（`SemiTerm/src/renderer/src/components/forms/AuthenticationFields.tsx`）
    - 認証方式フィールドを抽出
    - パスワード/秘密鍵の切り替えロジックを集約
    - 87行の再利用可能なコンポーネント
- 共通UIコンポーネントの抽出
  - CloseButtonコンポーネント（`SemiTerm/src/renderer/src/components/ui/CloseButton.tsx`）
    - 閉じるボタンの共通化
    - 24行の小さな再利用可能なコンポーネント
- App.tsxのリファクタリング
  - 385行から約270行に削減（約30%削減）
  - タブバーとコンテンツエリアのロジックを分離
  - イベントハンドラーのメモ化を維持

**成果**:
- TypeScriptコンパイル成功
- ビルド成功（エラーなし）
- App.tsxの行数削減（385行 → 約270行）
- ConnectionEditorの行数削減（188行 → 約120行）
- 5つの新しい再利用可能なコンポーネントを作成
- コンポーネントの責任分離の明確化
- テスタビリティの向上
- 保守性の向上

**コンポーネント構成の改善**:
1. **レイアウトコンポーネント**
   - TabBar: タブバーの表示とドラッグ&ドロップ
   - TabContentArea: タブコンテンツの表示切り替え
   - Sidebar: サイドバー（既存）
   - StatusBar: ステータスバー（既存）

2. **フォームコンポーネント**
   - ConnectionInfoFields: 接続情報入力フィールド
   - AuthenticationFields: 認証情報入力フィールド

3. **共通UIコンポーネント**
   - CloseButton: 閉じるボタン
   - その他のshadcn/uiコンポーネント（既存）

**最適化の詳細**:
- 全ての新規コンポーネントにReact.memoを適用
- カスタム比較関数による精密な再レンダリング制御
- イベントハンドラーのuseCallbackによるメモ化
- プロップスの最小化による依存関係の削減

**期待される効果**:
- コンポーネントの再利用性向上
- テストの書きやすさ向上
- 新機能追加の容易性向上
- バグ修正の影響範囲の明確化
- コードレビューの効率化
